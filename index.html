<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Supabase API Client</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100">
    <div class="flex h-screen overflow-hidden">
      <!-- Sidebar -->
      <aside class="w-64 bg-gray-900 text-white flex-shrink-0">
        <div class="p-6 border-b border-gray-800">
          <h1 class="text-2xl font-bold">Supabase Client</h1>
        </div>
        <nav
          class="p-4 overflow-y-auto"
          style="max-height: calc(100vh - 100px)"
        >
          <button
            onclick="showTab('config')"
            class="nav-btn w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-gray-800 transition"
            data-tab="config"
          >
            ‚öôÔ∏è Configuration
          </button>
          <button
            onclick="showTab('explorer')"
            class="nav-btn w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-gray-800 transition"
            data-tab="explorer"
          >
            üîç API Explorer
          </button>
          <button
            onclick="showTab('select')"
            class="nav-btn w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-gray-800 transition"
            data-tab="select"
          >
            üìã Select Data
          </button>
          <button
            onclick="showTab('insert')"
            class="nav-btn w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-gray-800 transition"
            data-tab="insert"
          >
            ‚ûï Insert Data
          </button>
          <button
            onclick="showTab('update')"
            class="nav-btn w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-gray-800 transition"
            data-tab="update"
          >
            ‚úèÔ∏è Update Data
          </button>
          <button
            onclick="showTab('delete')"
            class="nav-btn w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-gray-800 transition"
            data-tab="delete"
          >
            üóëÔ∏è Delete Data
          </button>
          <button
            onclick="showTab('rpc')"
            class="nav-btn w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-gray-800 transition"
            data-tab="rpc"
          >
            ‚ö° RPC Functions
          </button>
          <button
            onclick="showTab('auth')"
            class="nav-btn w-full text-left px-4 py-3 rounded-lg mb-2 hover:bg-gray-800 transition"
            data-tab="auth"
          >
            üîê Authentication
          </button>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 overflow-y-auto">
        <div class="p-8">
          <!-- Configuration Tab -->
          <div id="config-tab" class="tab-content">
            <h2 class="text-3xl font-bold mb-6">Configuration</h2>

            <!-- Saved Connections -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
              <h3 class="text-xl font-bold mb-4">üíæ Saved Connections</h3>
              <div id="saved-connections" class="mb-4">
                <!-- Saved connections will appear here -->
              </div>
              <button
                onclick="showConnectionForm()"
                class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition"
              >
                ‚ûï Add New Connection
              </button>
            </div>

            <!-- Connection Form -->
            <div
              id="connection-form"
              class="bg-white rounded-lg shadow-md p-6 hidden"
            >
              <h3 class="text-xl font-bold mb-4">Add/Edit Connection</h3>
              <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2"
                  >Connection Name</label
                >
                <input
                  type="text"
                  id="connection-name"
                  placeholder="My Project"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2"
                  >Supabase URL</label
                >
                <input
                  type="text"
                  id="supabase-url"
                  placeholder="https://your-project.supabase.co"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2"
                  >Supabase Anon Key</label
                >
                <input
                  type="password"
                  id="supabase-key"
                  placeholder="Your anon key"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2"
                  >Access Token (Optional)</label
                >
                <input
                  type="password"
                  id="supabase-token"
                  placeholder="Your access token (leave empty to use anon key)"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <p class="text-sm text-gray-600 mt-2">
                  If provided, this token will be used instead of the anon key
                  for authentication
                </p>
              </div>
              <div class="flex gap-2">
                <button
                  onclick="saveConnection()"
                  class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition"
                >
                  üíæ Save Connection
                </button>
                <button
                  onclick="hideConnectionForm()"
                  class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition"
                >
                  Cancel
                </button>
              </div>
              <div id="config-status" class="mt-4"></div>
            </div>

            <!-- Current Status -->
            <div class="bg-white rounded-lg shadow-md p-6 mt-6">
              <h3 class="text-xl font-bold mb-4">Current Status</h3>
              <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <p class="text-sm text-blue-800">
                  <strong>Active Connection:</strong><br />
                  <span id="auth-status">Not configured</span>
                </p>
              </div>
            </div>
          </div>

          <!-- API Explorer Tab -->
          <div id="explorer-tab" class="tab-content hidden">
            <h2 class="text-3xl font-bold mb-6">API Explorer</h2>

            <!-- OpenAPI Spec -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
              <h3 class="text-xl font-bold mb-4">üìÑ OpenAPI Specification</h3>
              <p class="text-gray-600 mb-4">
                Fetch the complete OpenAPI spec for your Supabase project
              </p>
              <div class="flex gap-2">
                <button
                  onclick="fetchOpenAPISpec()"
                  class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition"
                >
                  Fetch OpenAPI Spec
                </button>
                <button
                  onclick="clearResults('openapi-result')"
                  class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition"
                >
                  Clear Results
                </button>
              </div>
              <div id="openapi-result" class="mt-4"></div>
            </div>

            <!-- Tables List -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
              <h3 class="text-xl font-bold mb-4">üìä Available Tables</h3>
              <p class="text-gray-600 mb-4">
                Discover all tables in your database
              </p>
              <div class="flex gap-2">
                <button
                  onclick="fetchTables()"
                  class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition"
                >
                  List Tables
                </button>
                <button
                  onclick="clearResults('tables-result')"
                  class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition"
                >
                  Clear Results
                </button>
              </div>
              <div id="tables-result" class="mt-4"></div>
            </div>

            <!-- RPC Functions List -->
            <div class="bg-white rounded-lg shadow-md p-6">
              <h3 class="text-xl font-bold mb-4">‚ö° Available RPC Functions</h3>
              <p class="text-gray-600 mb-4">
                Discover all stored procedures/functions
              </p>
              <div class="flex gap-2">
                <button
                  onclick="fetchRPCFunctions()"
                  class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition"
                >
                  List RPC Functions
                </button>
                <button
                  onclick="clearResults('rpc-list-result')"
                  class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition"
                >
                  Clear Results
                </button>
              </div>
              <div id="rpc-list-result" class="mt-4"></div>
            </div>
          </div>

          <!-- Select Tab -->
          <div id="select-tab" class="tab-content hidden">
            <h2 class="text-3xl font-bold mb-6">Select Data</h2>
            <div class="bg-white rounded-lg shadow-md p-6">
              <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2"
                  >Table Name</label
                >
                <input
                  type="text"
                  id="select-table"
                  list="select-table-list"
                  placeholder="users"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <datalist id="select-table-list"></datalist>
              </div>
              <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2"
                  >Select Columns (comma-separated, * for all)</label
                >
                <input
                  type="text"
                  id="select-columns"
                  list="select-columns-list"
                  placeholder="*"
                  value="*"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <datalist id="select-columns-list"></datalist>
                <p class="text-sm text-gray-600 mt-1">
                  Available columns will appear after selecting a table
                </p>
              </div>
              <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2"
                  >Filter (optional, e.g., id=eq.1)</label
                >
                <input
                  type="text"
                  id="select-filter"
                  placeholder="column=eq.value"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2"
                  >Order By (optional, e.g., created_at.desc)</label
                >
                <input
                  type="text"
                  id="select-order"
                  list="select-order-list"
                  placeholder="column.asc or column.desc"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <datalist id="select-order-list"></datalist>
              </div>
              <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2"
                  >Limit</label
                >
                <input
                  type="number"
                  id="select-limit"
                  placeholder="10"
                  value="10"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div class="flex gap-2">
                <button
                  onclick="selectData()"
                  class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition"
                >
                  Fetch Data
                </button>
                <button
                  onclick="clearResults('select-result')"
                  class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition"
                >
                  Clear Results
                </button>
              </div>
              <div id="select-result" class="mt-4"></div>
            </div>
          </div>

          <!-- Insert Tab -->
          <div id="insert-tab" class="tab-content hidden">
            <h2 class="text-3xl font-bold mb-6">Insert Data</h2>
            <div class="bg-white rounded-lg shadow-md p-6">
              <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2"
                  >Table Name</label
                >
                <input
                  type="text"
                  id="insert-table"
                  list="insert-table-list"
                  placeholder="users"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <datalist id="insert-table-list"></datalist>
              </div>
              <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2"
                  >JSON Data</label
                >
                <textarea
                  id="insert-data"
                  rows="8"
                  placeholder='{"name": "John Doe", "email": "john@example.com"}'
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                ></textarea>
                <p class="text-sm text-gray-600 mt-2">
                  Enter a JSON object or array of objects
                </p>
              </div>
              <div class="flex gap-2">
                <button
                  onclick="insertData()"
                  class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition"
                >
                  Insert Data
                </button>
                <button
                  onclick="clearResults('insert-result')"
                  class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition"
                >
                  Clear Results
                </button>
              </div>
              <div id="insert-result" class="mt-4"></div>
            </div>
          </div>

          <!-- Update Tab -->
          <div id="update-tab" class="tab-content hidden">
            <h2 class="text-3xl font-bold mb-6">Update Data</h2>
            <div class="bg-white rounded-lg shadow-md p-6">
              <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2"
                  >Table Name</label
                >
                <input
                  type="text"
                  id="update-table"
                  list="update-table-list"
                  placeholder="users"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <datalist id="update-table-list"></datalist>
              </div>
              <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2"
                  >Filter (required, e.g., id=eq.1)</label
                >
                <input
                  type="text"
                  id="update-filter"
                  placeholder="id=eq.1"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2"
                  >JSON Data (fields to update)</label
                >
                <textarea
                  id="update-data"
                  rows="6"
                  placeholder='{"name": "Jane Doe"}'
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                ></textarea>
              </div>
              <div class="flex gap-2">
                <button
                  onclick="updateData()"
                  class="bg-yellow-600 text-white px-6 py-2 rounded-lg hover:bg-yellow-700 transition"
                >
                  Update Data
                </button>
                <button
                  onclick="clearResults('update-result')"
                  class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition"
                >
                  Clear Results
                </button>
              </div>
              <div id="update-result" class="mt-4"></div>
            </div>
          </div>

          <!-- Delete Tab -->
          <div id="delete-tab" class="tab-content hidden">
            <h2 class="text-3xl font-bold mb-6">Delete Data</h2>
            <div class="bg-white rounded-lg shadow-md p-6">
              <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2"
                  >Table Name</label
                >
                <input
                  type="text"
                  id="delete-table"
                  list="delete-table-list"
                  placeholder="users"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <datalist id="delete-table-list"></datalist>
              </div>
              <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2"
                  >Filter (required, e.g., id=eq.1)</label
                >
                <input
                  type="text"
                  id="delete-filter"
                  placeholder="id=eq.1"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                <p class="text-red-700 font-medium">
                  ‚ö†Ô∏è Warning: This action cannot be undone!
                </p>
              </div>
              <div class="flex gap-2">
                <button
                  onclick="deleteData()"
                  class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition"
                >
                  Delete Data
                </button>
                <button
                  onclick="clearResults('delete-result')"
                  class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition"
                >
                  Clear Results
                </button>
              </div>
              <div id="delete-result" class="mt-4"></div>
            </div>
          </div>

          <!-- RPC Tab -->
          <div id="rpc-tab" class="tab-content hidden">
            <h2 class="text-3xl font-bold mb-6">RPC Functions</h2>
            <div class="bg-white rounded-lg shadow-md p-6">
              <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2"
                  >Function Name</label
                >
                <input
                  type="text"
                  id="rpc-function"
                  list="rpc-function-list"
                  placeholder="my_function"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <datalist id="rpc-function-list"></datalist>
              </div>
              <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2"
                  >Parameters (JSON)</label
                >
                <textarea
                  id="rpc-params"
                  rows="8"
                  placeholder='{"param1": "value1", "param2": 123}'
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                ></textarea>
                <p class="text-sm text-gray-600 mt-2">
                  Enter a JSON object with function parameters. Use {} for no
                  parameters.
                </p>
              </div>
              <div class="flex gap-2">
                <button
                  onclick="callRPC()"
                  class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition"
                >
                  Call Function
                </button>
                <button
                  onclick="clearResults('rpc-result')"
                  class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition"
                >
                  Clear Results
                </button>
              </div>
              <div id="rpc-result" class="mt-4"></div>
            </div>
          </div>

          <!-- Auth Tab -->
          <div id="auth-tab" class="tab-content hidden">
            <h2 class="text-3xl font-bold mb-6">Authentication</h2>

            <!-- Sign Up -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
              <h3 class="text-xl font-bold mb-4">Sign Up</h3>
              <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2"
                  >Email</label
                >
                <input
                  type="email"
                  id="signup-email"
                  placeholder="user@example.com"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2"
                  >Password</label
                >
                <input
                  type="password"
                  id="signup-password"
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div class="flex gap-2">
                <button
                  onclick="signUp()"
                  class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition"
                >
                  Sign Up
                </button>
                <button
                  onclick="clearResults('signup-result')"
                  class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition"
                >
                  Clear Results
                </button>
              </div>
              <div id="signup-result" class="mt-4"></div>
            </div>

            <!-- Sign In -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
              <h3 class="text-xl font-bold mb-4">Sign In</h3>
              <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2"
                  >Email</label
                >
                <input
                  type="email"
                  id="signin-email"
                  placeholder="user@example.com"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2"
                  >Password</label
                >
                <input
                  type="password"
                  id="signin-password"
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div class="flex gap-2">
                <button
                  onclick="signIn()"
                  class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition"
                >
                  Sign In
                </button>
                <button
                  onclick="clearResults('signin-result')"
                  class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition"
                >
                  Clear Results
                </button>
              </div>
              <div id="signin-result" class="mt-4"></div>
            </div>

            <!-- Get User -->
            <div class="bg-white rounded-lg shadow-md p-6">
              <h3 class="text-xl font-bold mb-4">Get Current User</h3>
              <div class="flex gap-2">
                <button
                  onclick="getUser()"
                  class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition"
                >
                  Get User Info
                </button>
                <button
                  onclick="clearResults('user-result')"
                  class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition"
                >
                  Clear Results
                </button>
              </div>
              <div id="user-result" class="mt-4"></div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      // Configuration storage
      let config = {
        url: "",
        key: "",
        token: "",
      };

      // Cache for fetched data
      let cache = {
        tables: [],
        rpcFunctions: [],
        tableColumns: {},
      };

      // Saved connections
      let savedConnections = [];

      // Load config on page load
      window.onload = function () {
        // Load saved connections
        const savedConnsStr = localStorage.getItem("supabase-connections");
        if (savedConnsStr) {
          try {
            savedConnections = JSON.parse(savedConnsStr);
          } catch (e) {
            savedConnections = [];
          }
        }

        // Load last active connection
        const lastActiveId = localStorage.getItem("supabase-active-connection");
        if (lastActiveId) {
          const activeConn = savedConnections.find(
            (c) => c.id === lastActiveId
          );
          if (activeConn) {
            loadConnection(activeConn);
          }
        }

        renderSavedConnections();
        updateAuthStatus();

        // Set initial active tab
        document
          .querySelector('[data-tab="config"]')
          .classList.add("bg-gray-800");
      };

      // Tab switching
      function showTab(tabName) {
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.classList.add("hidden");
        });

        document.querySelectorAll(".nav-btn").forEach((btn) => {
          btn.classList.remove("bg-gray-800");
        });

        document.getElementById(tabName + "-tab").classList.remove("hidden");
        document
          .querySelector(`[data-tab="${tabName}"]`)
          .classList.add("bg-gray-800");
      }

      // Save configuration
      function saveConnection() {
        const name = document.getElementById("connection-name").value.trim();
        const url = document.getElementById("supabase-url").value.trim();
        const key = document.getElementById("supabase-key").value.trim();
        const token = document.getElementById("supabase-token").value.trim();

        if (!name) {
          showStatus(
            "config-status",
            "Please enter a connection name",
            "error"
          );
          return;
        }

        if (!url || !key) {
          showStatus(
            "config-status",
            "Please enter both URL and API key",
            "error"
          );
          return;
        }

        // Check if editing existing connection
        const editingId =
          document.getElementById("connection-form").dataset.editId;

        if (editingId) {
          // Update existing connection
          const index = savedConnections.findIndex((c) => c.id === editingId);
          if (index !== -1) {
            savedConnections[index] = {
              id: editingId,
              name,
              url,
              key,
              token,
              lastUsed: Date.now(),
            };
          }
        } else {
          // Create new connection
          const newConnection = {
            id: "conn-" + Date.now(),
            name,
            url,
            key,
            token,
            lastUsed: Date.now(),
          };
          savedConnections.push(newConnection);
        }

        // Save to localStorage
        localStorage.setItem(
          "supabase-connections",
          JSON.stringify(savedConnections)
        );

        // Load this connection as active
        const activeConn = editingId
          ? savedConnections.find((c) => c.id === editingId)
          : savedConnections[savedConnections.length - 1];

        loadConnection(activeConn);

        renderSavedConnections();
        hideConnectionForm();
        showStatus(
          "config-status",
          "Connection saved successfully!",
          "success"
        );
      }

      // Load a connection
      function loadConnection(connection) {
        config.url = connection.url;
        config.key = connection.key;
        config.token = connection.token || "";

        // Update last used timestamp
        connection.lastUsed = Date.now();
        const index = savedConnections.findIndex((c) => c.id === connection.id);
        if (index !== -1) {
          savedConnections[index] = connection;
          localStorage.setItem(
            "supabase-connections",
            JSON.stringify(savedConnections)
          );
        }

        // Save as active connection
        localStorage.setItem("supabase-active-connection", connection.id);

        updateAuthStatus();
        renderSavedConnections();
      }

      // Delete a connection
      function deleteConnection(connectionId) {
        if (!confirm("Are you sure you want to delete this connection?")) {
          return;
        }

        savedConnections = savedConnections.filter(
          (c) => c.id !== connectionId
        );
        localStorage.setItem(
          "supabase-connections",
          JSON.stringify(savedConnections)
        );

        // If deleted connection was active, clear config
        const activeId = localStorage.getItem("supabase-active-connection");
        if (activeId === connectionId) {
          config = { url: "", key: "", token: "" };
          localStorage.removeItem("supabase-active-connection");
          updateAuthStatus();
        }

        renderSavedConnections();
      }

      // Edit a connection
      function editConnection(connectionId) {
        const connection = savedConnections.find((c) => c.id === connectionId);
        if (!connection) return;

        document.getElementById("connection-name").value = connection.name;
        document.getElementById("supabase-url").value = connection.url;
        document.getElementById("supabase-key").value = connection.key;
        document.getElementById("supabase-token").value =
          connection.token || "";

        document.getElementById("connection-form").dataset.editId =
          connectionId;
        showConnectionForm();
      }

      // Show connection form
      function showConnectionForm() {
        document.getElementById("connection-form").classList.remove("hidden");
        document.getElementById("connection-form").dataset.editId = "";
        document.getElementById("connection-name").value = "";
        document.getElementById("supabase-url").value = "";
        document.getElementById("supabase-key").value = "";
        document.getElementById("supabase-token").value = "";
      }

      // Hide connection form
      function hideConnectionForm() {
        document.getElementById("connection-form").classList.add("hidden");
        document.getElementById("connection-form").dataset.editId = "";
        document.getElementById("config-status").innerHTML = "";
      }

      // Render saved connections
      function renderSavedConnections() {
        const container = document.getElementById("saved-connections");
        const activeId = localStorage.getItem("supabase-active-connection");

        if (savedConnections.length === 0) {
          container.innerHTML =
            '<p class="text-gray-500 text-sm">No saved connections. Click "Add New Connection" to get started.</p>';
          return;
        }

        // Sort by last used
        const sorted = [...savedConnections].sort(
          (a, b) => (b.lastUsed || 0) - (a.lastUsed || 0)
        );

        container.innerHTML = sorted
          .map((conn) => {
            const isActive = conn.id === activeId;
            const urlPreview =
              conn.url.length > 40
                ? conn.url.substring(0, 40) + "..."
                : conn.url;

            return `
                    <div class="border ${
                      isActive
                        ? "border-blue-500 bg-blue-50"
                        : "border-gray-300"
                    } rounded-lg p-4 mb-3">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-bold text-lg flex items-center gap-2">
                                    ${conn.name}
                                    ${
                                      isActive
                                        ? '<span class="text-xs bg-blue-500 text-white px-2 py-1 rounded">Active</span>'
                                        : ""
                                    }
                                </h4>
                                <p class="text-sm text-gray-600 mt-1">${urlPreview}</p>
                                <p class="text-xs text-gray-500 mt-1">
                                    ${
                                      conn.token
                                        ? "üîê Using custom token"
                                        : "üîë Using anon key"
                                    }
                                </p>
                            </div>
                            <div class="flex gap-2">
                                ${
                                  !isActive
                                    ? `<button onclick="loadConnection(savedConnections.find(c => c.id === '${conn.id}'))" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                                    Use
                                </button>`
                                    : ""
                                }
                                <button onclick="editConnection('${
                                  conn.id
                                }')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                    Edit
                                </button>
                                <button onclick="deleteConnection('${
                                  conn.id
                                }')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      // Clear token (legacy function, kept for compatibility)
      function clearToken() {
        config.token = "";
        updateAuthStatus();
      }

      // Update auth status display
      function updateAuthStatus() {
        const statusEl = document.getElementById("auth-status");
        if (!config.url || !config.key) {
          statusEl.innerHTML = "‚ùå Not configured";
          statusEl.className = "text-red-600 font-medium";
        } else {
          const activeId = localStorage.getItem("supabase-active-connection");
          const activeConn = savedConnections.find((c) => c.id === activeId);
          const connName = activeConn ? activeConn.name : "Custom";

          if (config.token) {
            statusEl.innerHTML = `‚úÖ ${connName} - Using custom access token`;
            statusEl.className = "text-green-600 font-medium";
          } else {
            statusEl.innerHTML = `‚úÖ ${connName} - Using anon key`;
            statusEl.className = "text-blue-600 font-medium";
          }
        }
      }

      // Clear results
      function clearResults(elementId) {
        document.getElementById(elementId).innerHTML = "";
      }

      // Fetch OpenAPI Spec
      async function fetchOpenAPISpec() {
        if (!checkConfig()) return;

        const url = `${config.url}/rest/v1/`;

        try {
          const headers = {
            apikey: config.key,
            Authorization: `Bearer ${config.token || config.key}`,
          };

          const response = await fetch(url, { headers });
          const data = await response.json();

          if (response.ok) {
            showStatus(
              "openapi-result",
              "OpenAPI spec fetched successfully!",
              "success"
            );
            showCollapsibleJSON(
              "openapi-result",
              data,
              "OpenAPI Specification"
            );
          } else {
            showStatus(
              "openapi-result",
              `Error: ${data.message || JSON.stringify(data)}`,
              "error"
            );
          }
        } catch (error) {
          showStatus("openapi-result", `Error: ${error.message}`, "error");
        }
      }

      // Fetch Tables from OpenAPI spec
      async function fetchTables() {
        if (!checkConfig()) return;

        const url = `${config.url}/rest/v1/`;

        try {
          const headers = {
            apikey: config.key,
            Authorization: `Bearer ${config.token || config.key}`,
          };

          const response = await fetch(url, { headers });
          const data = await response.json();

          if (response.ok && data.paths) {
            const tables = Object.keys(data.paths)
              .filter((path) => path.startsWith("/") && !path.includes("rpc"))
              .map((path) => path.substring(1));

            // Store tables in cache
            cache.tables = tables;

            // Store column information
            tables.forEach((table) => {
              const tableInfo = data.definitions?.[table];
              if (tableInfo?.properties) {
                cache.tableColumns[table] = Object.keys(tableInfo.properties);
              }
            });

            // Update all table dropdowns
            updateTableDropdowns();

            showStatus(
              "tables-result",
              `Found ${tables.length} table(s)`,
              "success"
            );

            const tableList = tables
              .map((table) => {
                const columns = cache.tableColumns[table] || [];
                return `
                            <div class="border border-gray-300 rounded-lg p-4 mb-3">
                                <h4 class="font-bold text-lg mb-2">üìä ${table}</h4>
                                ${
                                  columns.length > 0
                                    ? `<p class="text-sm text-gray-600">Columns: ${columns.join(
                                        ", "
                                      )}</p>`
                                    : ""
                                }
                            </div>
                        `;
              })
              .join("");

            document.getElementById(
              "tables-result"
            ).innerHTML += `<div class="mt-4">${tableList}</div>`;
          } else {
            showStatus(
              "tables-result",
              `Error: ${data.message || "Could not fetch tables"}`,
              "error"
            );
          }
        } catch (error) {
          showStatus("tables-result", `Error: ${error.message}`, "error");
        }
      }

      // Fetch RPC Functions from OpenAPI spec
      async function fetchRPCFunctions() {
        if (!checkConfig()) return;

        const url = `${config.url}/rest/v1/`;

        try {
          const headers = {
            apikey: config.key,
            Authorization: `Bearer ${config.token || config.key}`,
          };

          const response = await fetch(url, { headers });
          const data = await response.json();

          if (response.ok && data.paths) {
            const rpcFunctions = Object.keys(data.paths)
              .filter((path) => path.includes("/rpc/"))
              .map((path) => path.replace("/rpc/", ""));

            if (rpcFunctions.length === 0) {
              showStatus(
                "rpc-list-result",
                "No RPC functions found in your database",
                "info"
              );
              return;
            }

            // Store RPC functions in cache
            cache.rpcFunctions = rpcFunctions;

            // Update RPC dropdown
            updateRPCDropdown();

            showStatus(
              "rpc-list-result",
              `Found ${rpcFunctions.length} RPC function(s)`,
              "success"
            );

            const functionList = rpcFunctions
              .map((func) => {
                const funcPath = `/rpc/${func}`;
                const funcInfo = data.paths[funcPath]?.post;
                const params = funcInfo?.parameters || [];

                return `
                            <div class="border border-gray-300 rounded-lg p-4 mb-3">
                                <h4 class="font-bold text-lg mb-2">‚ö° ${func}</h4>
                                ${
                                  params.length > 0
                                    ? `<p class="text-sm text-gray-600">Parameters: ${params
                                        .map((p) => p.name)
                                        .join(", ")}</p>`
                                    : '<p class="text-sm text-gray-600">No parameters</p>'
                                }
                                <button onclick="useRPCFunction('${func}')" class="mt-2 bg-purple-500 text-white px-3 py-1 rounded text-sm hover:bg-purple-600">
                                    Use This Function
                                </button>
                            </div>
                        `;
              })
              .join("");

            document.getElementById(
              "rpc-list-result"
            ).innerHTML += `<div class="mt-4">${functionList}</div>`;
          } else {
            showStatus(
              "rpc-list-result",
              `Error: ${data.message || "Could not fetch RPC functions"}`,
              "error"
            );
          }
        } catch (error) {
          showStatus("rpc-list-result", `Error: ${error.message}`, "error");
        }
      }

      // Use RPC Function (navigate to RPC tab and populate function name)
      function useRPCFunction(functionName) {
        document.getElementById("rpc-function").value = functionName;
        showTab("rpc");
      }

      // Call RPC Function (FIXED: Correctly sends parameters in request body)
      async function callRPC() {
        if (!checkConfig()) return;

        const functionName = document.getElementById("rpc-function").value;
        const paramsText = document.getElementById("rpc-params").value.trim();

        if (!functionName) {
          showStatus("rpc-result", "Please enter a function name", "error");
          return;
        }

        let params = {};
        if (paramsText) {
          try {
            params = JSON.parse(paramsText);
          } catch (e) {
            showStatus(
              "rpc-result",
              "Invalid JSON format for parameters",
              "error"
            );
            return;
          }
        }

        const url = `${config.url}/rest/v1/rpc/${functionName}`;

        try {
          const headers = {
            apikey: config.key,
            Authorization: `Bearer ${config.token || config.key}`,
            "Content-Type": "application/json",
          };

          const response = await fetch(url, {
            method: "POST",
            headers,
            body: JSON.stringify(params),
          });

          const contentType = response.headers.get("content-type");
          let data;

          if (contentType && contentType.includes("application/json")) {
            data = await response.json();
          } else {
            data = await response.text();
          }

          if (response.ok) {
            showStatus(
              "rpc-result",
              "RPC function executed successfully!",
              "success"
            );
            showCollapsibleJSON(
              "rpc-result",
              data,
              `Response from ${functionName}()`
            );
          } else {
            showStatus(
              "rpc-result",
              `Error: ${
                typeof data === "object"
                  ? data.message || JSON.stringify(data)
                  : data
              }`,
              "error"
            );
          }
        } catch (error) {
          showStatus("rpc-result", `Error: ${error.message}`, "error");
        }
      }

      // Select data
      async function selectData() {
        if (!checkConfig()) return;

        const table = document.getElementById("select-table").value;
        const columns = document.getElementById("select-columns").value || "*";
        const filter = document.getElementById("select-filter").value;
        const order = document.getElementById("select-order").value;
        const limit = document.getElementById("select-limit").value;

        if (!table) {
          showStatus("select-result", "Please enter a table name", "error");
          return;
        }

        let url = `${config.url}/rest/v1/${table}?select=${columns}`;

        if (filter) {
          url += `&${filter}`;
        }

        if (order) {
          url += `&order=${order}`;
        }

        if (limit) {
          url += `&limit=${limit}`;
        }

        try {
          const headers = {
            apikey: config.key,
            Authorization: `Bearer ${config.token || config.key}`,
          };

          const response = await fetch(url, { headers });
          const data = await response.json();

          if (response.ok) {
            showStatus(
              "select-result",
              `Success! Retrieved ${data.length} record(s)`,
              "success"
            );
            showCollapsibleJSON("select-result", data, `Data from ${table}`);
          } else {
            showStatus(
              "select-result",
              `Error: ${data.message || JSON.stringify(data)}`,
              "error"
            );
          }
        } catch (error) {
          showStatus("select-result", `Error: ${error.message}`, "error");
        }
      }

      // Insert data
      async function insertData() {
        if (!checkConfig()) return;

        const table = document.getElementById("insert-table").value;
        const dataText = document.getElementById("insert-data").value;

        if (!table || !dataText) {
          showStatus(
            "insert-result",
            "Please enter table name and JSON data",
            "error"
          );
          return;
        }

        let data;
        try {
          data = JSON.parse(dataText);
        } catch (e) {
          showStatus("insert-result", "Invalid JSON format", "error");
          return;
        }

        const url = `${config.url}/rest/v1/${table}`;

        try {
          const headers = {
            apikey: config.key,
            Authorization: `Bearer ${config.token || config.key}`,
            "Content-Type": "application/json",
            Prefer: "return=representation",
          };

          const response = await fetch(url, {
            method: "POST",
            headers,
            body: JSON.stringify(data),
          });

          const result = await response.json();

          if (response.ok) {
            showStatus(
              "insert-result",
              "Data inserted successfully!",
              "success"
            );
            showCollapsibleJSON("insert-result", result, "Inserted Data");
          } else {
            showStatus(
              "insert-result",
              `Error: ${result.message || JSON.stringify(result)}`,
              "error"
            );
          }
        } catch (error) {
          showStatus("insert-result", `Error: ${error.message}`, "error");
        }
      }

      // Update data
      async function updateData() {
        if (!checkConfig()) return;

        const table = document.getElementById("update-table").value;
        const filter = document.getElementById("update-filter").value;
        const dataText = document.getElementById("update-data").value;

        if (!table || !filter || !dataText) {
          showStatus(
            "update-result",
            "Please enter table name, filter, and JSON data",
            "error"
          );
          return;
        }

        let data;
        try {
          data = JSON.parse(dataText);
        } catch (e) {
          showStatus("update-result", "Invalid JSON format", "error");
          return;
        }

        const url = `${config.url}/rest/v1/${table}?${filter}`;

        try {
          const headers = {
            apikey: config.key,
            Authorization: `Bearer ${config.token || config.key}`,
            "Content-Type": "application/json",
            Prefer: "return=representation",
          };

          const response = await fetch(url, {
            method: "PATCH",
            headers,
            body: JSON.stringify(data),
          });

          const result = await response.json();

          if (response.ok) {
            showStatus(
              "update-result",
              "Data updated successfully!",
              "success"
            );
            showCollapsibleJSON("update-result", result, "Updated Data");
          } else {
            showStatus(
              "update-result",
              `Error: ${result.message || JSON.stringify(result)}`,
              "error"
            );
          }
        } catch (error) {
          showStatus("update-result", `Error: ${error.message}`, "error");
        }
      }

      // Delete data
      async function deleteData() {
        if (!checkConfig()) return;

        const table = document.getElementById("delete-table").value;
        const filter = document.getElementById("delete-filter").value;

        if (!table || !filter) {
          showStatus(
            "delete-result",
            "Please enter table name and filter",
            "error"
          );
          return;
        }

        if (
          !confirm(
            "Are you sure you want to delete this data? This action cannot be undone."
          )
        ) {
          return;
        }

        const url = `${config.url}/rest/v1/${table}?${filter}`;

        try {
          const headers = {
            apikey: config.key,
            Authorization: `Bearer ${config.token || config.key}`,
          };

          const response = await fetch(url, {
            method: "DELETE",
            headers,
          });

          if (response.ok) {
            showStatus(
              "delete-result",
              "Data deleted successfully!",
              "success"
            );
          } else {
            const result = await response.json();
            showStatus(
              "delete-result",
              `Error: ${result.message || JSON.stringify(result)}`,
              "error"
            );
          }
        } catch (error) {
          showStatus("delete-result", `Error: ${error.message}`, "error");
        }
      }

      // Sign up
      async function signUp() {
        if (!checkConfig()) return;

        const email = document.getElementById("signup-email").value;
        const password = document.getElementById("signup-password").value;

        if (!email || !password) {
          showStatus(
            "signup-result",
            "Please enter email and password",
            "error"
          );
          return;
        }

        const url = `${config.url}/auth/v1/signup`;

        try {
          const response = await fetch(url, {
            method: "POST",
            headers: {
              apikey: config.key,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email, password }),
          });

          const data = await response.json();

          if (response.ok) {
            showStatus(
              "signup-result",
              "Sign up successful! Check your email for confirmation.",
              "success"
            );
            showCollapsibleJSON("signup-result", data, "Signup Response");
          } else {
            showStatus(
              "signup-result",
              `Error: ${data.message || JSON.stringify(data)}`,
              "error"
            );
          }
        } catch (error) {
          showStatus("signup-result", `Error: ${error.message}`, "error");
        }
      }

      // Sign in
      async function signIn() {
        if (!checkConfig()) return;

        const email = document.getElementById("signin-email").value;
        const password = document.getElementById("signin-password").value;

        if (!email || !password) {
          showStatus(
            "signin-result",
            "Please enter email and password",
            "error"
          );
          return;
        }

        const url = `${config.url}/auth/v1/token?grant_type=password`;

        try {
          const response = await fetch(url, {
            method: "POST",
            headers: {
              apikey: config.key,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email, password }),
          });

          const data = await response.json();

          if (response.ok) {
            config.token = data.access_token;
            localStorage.setItem("supabase-token", data.access_token);
            showStatus("signin-result", "Sign in successful!", "success");
            showCollapsibleJSON("signin-result", data, "Signin Response");
          } else {
            showStatus(
              "signin-result",
              `Error: ${data.message || JSON.stringify(data)}`,
              "error"
            );
          }
        } catch (error) {
          showStatus("signin-result", `Error: ${error.message}`, "error");
        }
      }

      // Get user
      async function getUser() {
        if (!checkConfig()) return;

        if (!config.token) {
          showStatus("user-result", "Please sign in first", "error");
          return;
        }

        const url = `${config.url}/auth/v1/user`;

        try {
          const response = await fetch(url, {
            headers: {
              apikey: config.key,
              Authorization: `Bearer ${config.token}`,
            },
          });

          const data = await response.json();

          if (response.ok) {
            showStatus(
              "user-result",
              "User info retrieved successfully!",
              "success"
            );
            showCollapsibleJSON("user-result", data, "User Information");
          } else {
            showStatus(
              "user-result",
              `Error: ${data.message || JSON.stringify(data)}`,
              "error"
            );
          }
        } catch (error) {
          showStatus("user-result", `Error: ${error.message}`, "error");
        }
      }

      // Helper functions
      function checkConfig() {
        if (!config.url || !config.key) {
          alert("Please configure your Supabase URL and API key first!");
          showTab("config");
          return false;
        }
        return true;
      }

      function showStatus(elementId, message, type) {
        const el = document.getElementById(elementId);
        let color = "blue";
        if (type === "success") color = "green";
        else if (type === "error") color = "red";
        else if (type === "info") color = "blue";

        const existingContent = el.innerHTML;
        el.innerHTML =
          `<div class="bg-${color}-100 border border-${color}-300 text-${color}-800 px-4 py-3 rounded-lg mb-2">${message}</div>` +
          existingContent;
      }

      function showCollapsibleJSON(elementId, data, title) {
        const el = document.getElementById(elementId);
        const jsonStr = JSON.stringify(data, null, 2);
        const collapseId = "collapse-" + Date.now();

        const html = `
                <div class="mt-4 border border-gray-300 rounded-lg overflow-hidden">
                    <button onclick="toggleCollapse('${collapseId}')" class="w-full bg-gray-800 text-white px-4 py-3 text-left hover:bg-gray-700 transition flex justify-between items-center">
                        <span class="font-semibold">${title}</span>
                        <span id="${collapseId}-icon">‚ñº</span>
                    </button>
                    <div id="${collapseId}" class="bg-gray-900 text-green-400 p-4 overflow-x-auto">
                        <pre>${jsonStr}</pre>
                    </div>
                </div>
            `;

        el.innerHTML += html;
      }

      function toggleCollapse(id) {
        const element = document.getElementById(id);
        const icon = document.getElementById(id + "-icon");

        if (element.style.display === "none") {
          element.style.display = "block";
          icon.textContent = "‚ñº";
        } else {
          element.style.display = "none";
          icon.textContent = "‚ñ∂";
        }
      }

      // Update table dropdowns with cached data
      function updateTableDropdowns() {
        const tableInputs = [
          "select-table-list",
          "insert-table-list",
          "update-table-list",
          "delete-table-list",
        ];

        tableInputs.forEach((inputId) => {
          const datalist = document.getElementById(inputId);
          datalist.innerHTML = "";
          cache.tables.forEach((table) => {
            const option = document.createElement("option");
            option.value = table;
            datalist.appendChild(option);
          });
        });
      }

      // Update RPC dropdown with cached data
      function updateRPCDropdown() {
        const datalist = document.getElementById("rpc-function-list");
        datalist.innerHTML = "";
        cache.rpcFunctions.forEach((func) => {
          const option = document.createElement("option");
          option.value = func;
          datalist.appendChild(option);
        });
      }

      // Update columns dropdown based on selected table
      function updateColumnsDropdown(tableName) {
        const columns = cache.tableColumns[tableName] || [];

        const columnDatalistIds = ["select-columns-list", "select-order-list"];

        columnDatalistIds.forEach((listId) => {
          const datalist = document.getElementById(listId);
          datalist.innerHTML = "";

          // Add individual columns
          columns.forEach((col) => {
            const option = document.createElement("option");
            option.value = col;
            datalist.appendChild(option);
          });

          // Add sorting options for order dropdown
          if (listId === "select-order-list") {
            columns.forEach((col) => {
              const optionAsc = document.createElement("option");
              optionAsc.value = `${col}.asc`;
              datalist.appendChild(optionAsc);

              const optionDesc = document.createElement("option");
              optionDesc.value = `${col}.desc`;
              datalist.appendChild(optionDesc);
            });
          }
        });
      }

      // Listen for table selection changes
      document.addEventListener("DOMContentLoaded", function () {
        const selectTableInput = document.getElementById("select-table");
        if (selectTableInput) {
          selectTableInput.addEventListener("input", function () {
            updateColumnsDropdown(this.value);
          });
        }
      });
    </script>
  </body>
</html>
